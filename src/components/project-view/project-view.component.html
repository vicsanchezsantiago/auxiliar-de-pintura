<div *ngIf="projectPlan as plan" class="max-w-5xl mx-auto print-bg-white print-text-black">
  <!-- Header -->
  <div class="flex justify-between items-start mb-6">
    <div>
      <h1 class="text-3xl font-bold text-teal-300 print-text-black">{{ plan.projectName }}</h1>
      <p class="text-md text-gray-400 print-text-black">{{ plan.source }}</p>
    </div>
    <div class="flex gap-2 no-print">
      <button (click)="openRegionSelector()" 
        class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-md flex items-center gap-2 transition-colors text-sm border border-gray-600">
        üìê Ajustar Regi√µes
      </button>
      <button (click)="printPlan()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md flex items-center gap-2 transition-colors text-sm">
        üñ®Ô∏è Imprimir / PDF
      </button>
    </div>
  </div>

  <!-- Loading de regenera√ß√£o -->
  <div *ngIf="isRegenerating()" class="mb-6 bg-teal-900 bg-opacity-50 border border-teal-600 p-4 rounded-lg flex items-center gap-3 no-print">
    <svg class="animate-spin h-5 w-5 text-teal-400" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-teal-200 font-medium">Regenerando projeto com as novas regi√µes...</span>
  </div>

  <!-- Warnings -->
  <section *ngIf="plan.warnings && plan.warnings.length > 0" class="mb-6 bg-yellow-900 bg-opacity-40 border-l-4 border-yellow-400 p-3 rounded-r-lg no-print">
    <h2 class="text-lg font-semibold text-yellow-300 mb-1">‚ö†Ô∏è Avisos</h2>
    <ul class="list-disc list-inside space-y-1 text-yellow-200 text-sm">
      <li *ngFor="let warning of plan.warnings">{{ warning }}</li>
    </ul>
  </section>

  <!-- SE√á√ÉO: Paleta de Cores -->
  <section *ngIf="plan.identifiedColors && plan.identifiedColors.length > 0" class="mb-6">
    <h2 class="text-xl font-semibold border-b-2 border-teal-500 pb-1 mb-3 print-text-black print-text-sm">
      üé® Paleta de Cores ({{ plan.identifiedColors.length }})
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse print-table">
        <thead>
          <tr class="bg-gray-700 text-gray-300 uppercase tracking-wider text-xs">
            <th class="px-2 py-1.5 text-left w-8">Cor</th>
            <th class="px-2 py-1.5 text-left">Nome</th>
            <th class="px-2 py-1.5 text-left">Localiza√ß√£o</th>
            <th class="px-2 py-1.5 text-left">Tinta / Mistura</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let color of plan.identifiedColors; let odd = odd" 
              class="border-b border-gray-700 print-text-black"
              [ngClass]="{'bg-gray-800': odd}">
            <td class="px-2 py-1">
              <div class="w-6 h-6 rounded border border-gray-600 flex-shrink-0" 
                   [style.background-color]="color.hex"
                   [title]="color.hex"></div>
            </td>
            <td class="px-2 py-1">
              <span class="font-semibold print-text-black">{{ color.colorName }}</span>
              <span class="text-gray-500 font-mono text-xs ml-1">{{ color.hex }}</span>
            </td>
            <td class="px-2 py-1 text-gray-400 print-text-black">{{ color.location }}</td>
            <td class="px-2 py-1">
              <div *ngIf="color.matchedPaint && !color.needsMixing" class="flex items-center gap-1.5">
                <span class="text-green-400">‚úì</span>
                <span class="text-green-200 print-text-black">{{ color.matchedPaint.name }}</span>
                <span class="text-gray-500 text-xs">({{ color.matchedPaint.brand }})</span>
              </div>
              <div *ngIf="color.needsMixing && color.mixRecipe" class="flex flex-wrap items-center gap-1">
                <span class="text-orange-400">‚öóÔ∏è</span>
                <ng-container *ngFor="let comp of color.mixRecipe.components; let last = last">
                  <span class="inline-flex items-center gap-1 bg-gray-700 px-1.5 py-0.5 rounded text-xs">
                    <span class="w-3 h-3 rounded-full inline-block border border-gray-500" [style.background-color]="comp.hex"></span>
                    <span class="font-bold text-orange-300">{{ comp.ratio }}x</span>
                    <span class="text-gray-300 truncate max-w-[140px]">{{ comp.paint }}</span>
                  </span>
                  <span *ngIf="!last" class="text-gray-500">+</span>
                </ng-container>
              </div>
              <div *ngIf="color.needsMixing && !color.mixRecipe">
                <span class="text-orange-400">‚öóÔ∏è Precisa misturar</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- SE√á√ÉO: Passos de Pintura -->
  <section class="mb-8">
    <h2 class="text-xl font-semibold border-b-2 border-teal-500 pb-2 mb-3 print-text-black">
      üìã Passos de Pintura ({{ plan.steps?.length || 0 }})
    </h2>
    
    <div *ngIf="plan.steps && plan.steps.length > 0" class="space-y-4">
      <div *ngFor="let step of plan.steps" class="bg-gray-800 rounded-lg overflow-hidden print-border print-bg-white page-break-inside-avoid">
        
        <!-- Header do passo -->
        <div class="flex items-center gap-3 p-3 bg-gray-700" [style.border-left]="'5px solid ' + (step.baseColor?.hex || '#14b8a6')">
          <div class="flex-shrink-0 w-10 h-10 bg-teal-600 rounded-full flex items-center justify-center text-lg font-bold text-white">
            {{ step.stepNumber }}
          </div>
          <div class="flex-grow min-w-0">
            <h3 class="font-bold text-lg text-teal-300 print-text-black">{{ step.partName }}</h3>
            <p class="text-sm text-gray-300 print-text-black">{{ step.partDescription }}</p>
          </div>
          <div *ngIf="step.baseColor" class="flex items-center gap-1.5 flex-shrink-0">
            <div class="w-8 h-8 rounded border-2 border-gray-500" [style.background-color]="step.baseColor.hex"></div>
            <span class="text-xs text-gray-400 hidden sm:inline">{{ step.baseColor.name }}</span>
          </div>
        </div>

        <div class="p-4">
          <div class="flex flex-col lg:flex-row gap-4">
            
            <!-- Regi√£o da imagem -->
            <div *ngIf="step.imageRegions && step.imageRegions.length > 0" class="flex-shrink-0 lg:w-48 no-print">
              <div class="relative bg-gray-900 rounded-lg overflow-hidden border-2 border-gray-600 w-48 h-48">
                <canvas #regionCanvas 
                  [attr.data-step]="step.stepNumber" 
                  [attr.data-region]="carouselIndices()[step.stepNumber] || 0" 
                  width="192" height="192"
                  class="w-full h-full object-contain"></canvas>
              </div>
              <div *ngIf="step.imageRegions.length > 1" class="flex items-center justify-center gap-2 mt-1">
                <button (click)="changeImage(step.stepNumber, step.imageRegions.length, -1)" 
                  title="Imagem anterior"
                  class="w-6 h-6 bg-gray-600 rounded-full hover:bg-teal-600 transition-colors flex items-center justify-center">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <span class="text-xs font-mono text-gray-300">{{ (carouselIndices()[step.stepNumber] || 0) + 1 }}/{{ step.imageRegions.length }}</span>
                <button (click)="changeImage(step.stepNumber, step.imageRegions.length, 1)" 
                  title="Pr√≥xima imagem"
                  class="w-6 h-6 bg-gray-600 rounded-full hover:bg-teal-600 transition-colors flex items-center justify-center">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </button>
              </div>
            </div>

            <!-- Detalhes -->
            <div class="flex-grow space-y-3">
              
              <!-- Tintas do passo -->
              <div *ngIf="step.paintsToUse && step.paintsToUse.length > 0">
                <p class="text-xs text-gray-400 uppercase tracking-wide mb-1">Tintas</p>
                <div class="flex flex-wrap gap-1.5">
                  <div *ngFor="let paint of step.paintsToUse" 
                       class="flex items-center gap-1.5 bg-gray-700 px-2.5 py-1.5 rounded-lg text-sm print-bg-white print-border">
                    <div class="w-4 h-4 rounded-full border-2 flex-shrink-0" 
                         [style.background-color]="paint.hex"
                         [style.border-color]="paint.purpose === 'sombra' ? '#6b7280' : paint.purpose === 'luz' ? '#fbbf24' : '#14b8a6'"></div>
                    <span class="text-gray-400 text-xs print-text-black" *ngIf="paint.brand">{{ paint.brand }} ¬∑</span>
                    <span class="truncate max-w-[160px] font-medium print-text-black">{{ paint.name }}</span>
                    <span class="text-xs font-semibold px-1.5 py-0.5 rounded-full"
                          [ngClass]="{
                            'bg-teal-900 text-teal-300': paint.purpose === 'base',
                            'bg-gray-600 text-gray-300': paint.purpose === 'sombra',
                            'bg-yellow-900 text-yellow-300': paint.purpose === 'luz',
                            'bg-purple-900 text-purple-300': paint.purpose === 'wash' || paint.purpose === 'glaze',
                            'bg-gray-700 text-gray-400': !paint.purpose || !['base','sombra','luz','wash','glaze'].includes(paint.purpose)
                          }">{{ getPurposeLabel(paint.purpose) }}</span>
                  </div>
                </div>
              </div>

              <!-- Grid t√©cnica/ferramenta/dilui√ß√£o -->
              <div class="grid grid-cols-3 gap-2 text-sm">
                <div class="bg-gray-700 p-2.5 rounded">
                  <p class="text-gray-500 text-xs uppercase mb-0.5">T√©cnica</p>
                  <p class="font-semibold text-teal-300 print-text-black">{{ getTechniqueLabel(step.technique) }}</p>
                </div>
                <div class="bg-gray-700 p-2.5 rounded">
                  <p class="text-gray-500 text-xs uppercase mb-0.5">Ferramenta</p>
                  <p class="font-semibold text-white print-text-black">{{ step.tool }}</p>
                  <p *ngIf="step.toolDetails" class="text-xs text-gray-400">{{ step.toolDetails }}</p>
                </div>
                <div class="bg-gray-700 p-2.5 rounded">
                  <p class="text-gray-500 text-xs uppercase mb-0.5">Dilui√ß√£o</p>
                  <p class="font-semibold text-white print-text-black">{{ step.dilution?.ratio || step.dilution }}</p>
                  <p *ngIf="step.dilution?.description" class="text-xs text-gray-400">{{ step.dilution.description }}</p>
                </div>
              </div>

              <!-- Mistura -->
              <div *ngIf="step.paintMix && step.paintMix.targetColor && step.paintMix.components && step.paintMix.components.length > 0" 
                   class="bg-orange-900 bg-opacity-20 border border-orange-700 p-3 rounded">
                <p class="text-xs text-orange-400 uppercase mb-1.5">‚öóÔ∏è Mistura</p>
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-7 h-7 rounded border-2 border-orange-500" [style.background-color]="step.paintMix.targetHex"></div>
                  <span class="font-semibold text-sm">{{ step.paintMix.targetColor }}</span>
                </div>
                <div class="flex flex-wrap items-center gap-2 mb-2">
                  <ng-container *ngFor="let comp of step.paintMix.components; let last = last">
                    <div class="flex items-center gap-1.5 bg-gray-700 px-2 py-1 rounded">
                      <div class="w-4 h-4 rounded-full border border-gray-500 flex-shrink-0" [style.background-color]="comp.hex"></div>
                      <span class="text-orange-300 font-bold text-sm">{{ comp.ratio }}x</span>
                      <span class="text-sm text-gray-300 truncate max-w-[140px]">{{ comp.paint }}</span>
                    </div>
                    <span *ngIf="!last" class="text-gray-500 font-bold">+</span>
                  </ng-container>
                </div>
                <p class="text-xs text-gray-300 italic">{{ step.paintMix.instructions }}</p>
              </div>

              <!-- Dicas -->
              <div *ngIf="step.tips && step.tips.length > 0" class="bg-teal-900 bg-opacity-30 border-l-4 border-teal-500 p-2.5 rounded-r">
                <p class="text-xs text-teal-400 uppercase mb-1">üí° Dicas</p>
                <ul class="space-y-0.5">
                  <li *ngFor="let tip of step.tips" class="text-sm text-teal-200 print-text-black">‚Ä¢ {{ tip }}</li>
                </ul>
              </div>

              <!-- Avisos -->
              <div *ngIf="step.warnings && step.warnings.length > 0" class="bg-yellow-900 bg-opacity-30 border-l-4 border-yellow-500 p-2.5 rounded-r">
                <p class="text-xs text-yellow-400 uppercase mb-1">‚ö†Ô∏è Aten√ß√£o</p>
                <ul class="space-y-0.5">
                  <li *ngFor="let warning of step.warnings" class="text-sm text-yellow-200 print-text-black">‚Ä¢ {{ warning }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <p *ngIf="!plan.steps || plan.steps.length === 0" class="text-gray-400 italic text-lg">Nenhum passo de pintura gerado. Tente novamente.</p>
  </section>

  <!-- SE√á√ÉO: Dicas de Fixa√ß√£o -->
  <section *ngIf="plan.fixationTips && plan.fixationTips.length > 0" class="mb-8">
    <h2 class="text-xl font-semibold border-b-2 border-teal-500 pb-2 mb-3 print-text-black">üõ°Ô∏è Dicas de Fixa√ß√£o</h2>
    <div class="bg-gray-800 p-4 rounded-lg print-bg-white print-border">
      <ul class="space-y-1.5">
        <li *ngFor="let tip of plan.fixationTips" class="flex items-start gap-2 print-text-black text-sm">
          <span class="text-teal-400">‚úì</span>
          <span>{{ tip }}</span>
        </li>
      </ul>
    </div>
  </section>
</div>

<div *ngIf="!projectPlan" class="text-center py-20">
  <div class="text-6xl mb-4">üé®</div>
  <h2 class="text-2xl font-bold mb-2">Nenhum projeto carregado</h2>
  <p class="text-gray-400">V√° para "Novo Projeto" para gerar um plano de pintura completo.</p>
</div>

<!-- Modal de sele√ß√£o de regi√µes (para projeto j√° gerado) -->
<app-region-selector 
  *ngIf="showRegionSelector() && projectPlan?.referenceImage"
  [imageBase64]="projectPlan!.referenceImage!.data"
  [imageType]="projectPlan!.referenceImage!.type"
  [existingRegions]="getExistingRegions()"
  (regionsConfirmed)="onRegionsConfirmed($event)"
  (cancelled)="onRegionsCancelled()"
  (identifyParts)="onIdentifyParts()">
</app-region-selector>
